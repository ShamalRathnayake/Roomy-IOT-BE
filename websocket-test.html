<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roomy Sensor Data WebSocket Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .registered {
        background-color: #cce5ff;
        color: #004085;
      }
      .data-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }
      .sensor-data {
        background: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }
      .timestamp {
        color: #666;
        font-size: 0.9em;
      }
      .sensor-values {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .sensor-value {
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px;
        font-size: 14px;
      }
      .device-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border-left: 4px solid #28a745;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîå Roomy Sensor Data WebSocket Test</h1>

      <div id="connectionStatus" class="status disconnected">Disconnected</div>

      <div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
        <button onclick="clearData()">Clear Data</button>
      </div>

      <div id="deviceRegistration" style="display: none;">
        <h3>üì± Device Registration:</h3>
        <div>
          <input
            type="text"
            id="deviceIdInput"
            placeholder="Enter Device ID"
            value="device001"
          />
          <button id="registerBtn" onclick="registerDevice()">Register Device</button>
        </div>
      </div>

      <div id="deviceInfo" class="device-info" style="display: none;">
        <h4>üì± Device Information:</h4>
        <p>Client ID: <span id="clientId">-</span></p>
        <p>Device ID: <span id="deviceId">-</span></p>
        <p>Total Clients: <span id="totalClients">0</span></p>
      </div>

      <div>
        <h3>üìä Real-time Sensor Data:</h3>
        <div id="sensorDataContainer" class="data-container">
          <p>No sensor data received yet...</p>
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let dataCount = 0;
      let currentDeviceId = null;

      function connect() {
        if (socket) return;

        // Connect to WebSocket server
        socket = io('http://localhost:4000');

        socket.on('connect', () => {
          updateStatus('Connected - Please register device', 'connected');
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('disconnectBtn').disabled = false;
          document.getElementById('deviceRegistration').style.display = 'block';
        });

        socket.on('disconnect', () => {
          updateStatus('Disconnected', 'disconnected');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('deviceRegistration').style.display = 'none';
          document.getElementById('deviceInfo').style.display = 'none';
        });

        socket.on('connectionInfo', (info) => {
          document.getElementById('clientId').textContent = info.clientId;
          document.getElementById('totalClients').textContent = info.totalClients;
          console.log('Connection info:', info);
        });

        socket.on('deviceRegistered', (info) => {
          currentDeviceId = info.deviceId;
          document.getElementById('deviceId').textContent = info.deviceId;
          document.getElementById('totalClients').textContent = info.totalClients;
          updateStatus(`Device ${info.deviceId} registered`, 'registered');
          document.getElementById('deviceInfo').style.display = 'block';
          console.log('Device registered:', info);
        });

        socket.on('error', (error) => {
          showError(error.message);
          console.error('WebSocket error:', error);
        });

        socket.on('sensorData', (data) => {
          displaySensorData(data);
        });
      }

      function registerDevice() {
        if (!socket) return;

        const deviceId = document.getElementById('deviceIdInput').value.trim();
        if (!deviceId) {
          showError('Please enter a device ID');
          return;
        }

        socket.emit('registerDevice', deviceId);
        console.log('Registering device:', deviceId);
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          currentDeviceId = null;
          updateStatus('Disconnected', 'disconnected');
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('deviceRegistration').style.display = 'none';
          document.getElementById('deviceInfo').style.display = 'none';
        }
      }

      function updateStatus(message, type) {
        const statusEl = document.getElementById('connectionStatus');
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
        
        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      function displaySensorData(data) {
        const container = document.getElementById('sensorDataContainer');
        dataCount++;

        const dataDiv = document.createElement('div');
        dataDiv.className = 'sensor-data';

        const timestamp = new Date(data.timestamp).toLocaleString();
        const sensorData = data.data;
        const deviceId = data.deviceId;

        let html = `
                <div class="timestamp">üìÖ ${timestamp} (Message #${dataCount}) - Device: ${deviceId}</div>
                <div class="sensor-values">
            `;

        // Display all sensor values
        Object.entries(sensorData).forEach(([key, value]) => {
          if (key !== '_id' && key !== '__v' && key !== 'timestamp') {
            const displayValue =
              typeof value === 'boolean' ? (value ? '‚úÖ Yes' : '‚ùå No') : value;
            html += `<div class="sensor-value"><strong>${key}:</strong> ${displayValue}</div>`;
          }
        });

        html += '</div>';
        dataDiv.innerHTML = html;

        // Add to top of container
        container.insertBefore(dataDiv, container.firstChild);

        // Keep only last 20 messages
        const messages = container.querySelectorAll('.sensor-data');
        if (messages.length > 20) {
          messages[messages.length - 1].remove();
        }
      }

      function clearData() {
        const container = document.getElementById('sensorDataContainer');
        container.innerHTML = '<p>No sensor data received yet...</p>';
        dataCount = 0;
      }

      // Auto-connect on page load
      window.onload = () => {
        setTimeout(connect, 1000);
      };
    </script>
  </body>
</html>
